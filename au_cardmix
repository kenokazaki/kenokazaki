SELECT DISTINCT du.BEST_AVAILABLE_MERCHANT_TOKEN
, SUM(fpt.AMOUNT_BASE_UNIT) / 100 AS total_gpv
, COUNT(fpt.PAYMENT_TOKEN) AS trx_volume
, (SUM(CASE WHEN dc.IS_DEBIT = 1 AND dc.ISSUING_COUNTRY = 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) + IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0)) / SUM(CASE WHEN dc.IS_DEBIT = 1 THEN fpt.AMOUNT_BASE_UNIT END) AS domestic_debit_gpv_split
, SUM(CASE WHEN dc.IS_DEBIT = 1 AND dc.ISSUING_COUNTRY != 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN  fpt.AMOUNT_BASE_UNIT END) / SUM(CASE WHEN dc.IS_DEBIT = 1 THEN fpt.AMOUNT_BASE_UNIT END) AS international_debit_gpv_split
, SUM(CASE WHEN dc.IS_CREDIT = 1 AND dc.ISSUING_COUNTRY = 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) / SUM(CASE WHEN dc.IS_CREDIT = 1 THEN fpt.AMOUNT_BASE_UNIT END) AS domestic_credit_gpv_split
, SUM(CASE WHEN dc.IS_CREDIT = 1 AND dc.ISSUING_COUNTRY != 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) / SUM(CASE WHEN dc.IS_CREDIT = 1 THEN fpt.AMOUNT_BASE_UNIT END) AS international_credit_gpv_split
, (SUM(CASE WHEN dc.IS_DEBIT = 1 AND dc.ISSUING_COUNTRY = 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) + IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0)) / 100 AS domestic_debit_gpv
, IFNULL(SUM(CASE WHEN dc.IS_DEBIT = 1 AND dc.ISSUING_COUNTRY != 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0) / 100 AS international_debit_gpv
, SUM(CASE WHEN dc.IS_CREDIT = 1 AND dc.ISSUING_COUNTRY = 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) / 100 AS domestic_credit_gpv
, IFNULL(SUM(CASE WHEN dc.IS_CREDIT = 1 AND dc.ISSUING_COUNTRY != 'AU' AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0) / 100 AS international_credit_gpv
, (SUM(CASE WHEN dc.IS_DEBIT = 1 AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) + IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0)) / SUM(fpt.AMOUNT_BASE_UNIT) AS debit_gpv_split
, SUM(CASE WHEN dc.IS_CREDIT = 1 AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) / SUM(fpt.AMOUNT_BASE_UNIT) AS credit_gpv_split
, (SUM(CASE WHEN dc.IS_DEBIT = 1 AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) + IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0)) / 100 AS debit_gpv
, SUM(CASE WHEN dc.IS_CREDIT = 1 AND fpt.CARD_BRAND != 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) / 100 AS credit_gpv
, SUM(CASE WHEN fpt.card_brand = 'VISA' THEN fpt.AMOUNT_BASE_UNIT END) / 100 AS visa_gpv
, SUM(CASE WHEN fpt.CARD_BRAND = 'MASTER_CARD' THEN fpt.AMOUNT_BASE_UNIT END) / 100 AS mastercard_gpv
, IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'AMERICAN_EXPRESS' THEN fpt.AMOUNT_BASE_UNIT END),0) / 100 AS amex_gpv
, IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0) / 100 AS eftpos_gpv
, SUM(CASE WHEN fpt.card_brand = 'VISA' THEN fpt.AMOUNT_BASE_UNIT END) / SUM(fpt.AMOUNT_BASE_UNIT) AS visa_gpv_split
, SUM(CASE WHEN fpt.CARD_BRAND = 'MASTER_CARD' THEN fpt.AMOUNT_BASE_UNIT END) / SUM(fpt.AMOUNT_BASE_UNIT) AS mastercard_gpv_split
, IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'AMERICAN_EXPRESS' THEN fpt.AMOUNT_BASE_UNIT END),0) / SUM(fpt.AMOUNT_BASE_UNIT) AS amex_gpv_split
, IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END),0) / SUM(fpt.AMOUNT_BASE_UNIT) AS eftpos_gpv_split
, COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'VISA' THEN fpt.PAYMENT_TOKEN END) AS visa_volume
, COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'MASTER_CARD' THEN fpt.PAYMENT_TOKEN END) AS mastercard_volume
, COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'AMERICAN_EXPRESS' THEN fpt.PAYMENT_TOKEN END) AS amex_volume
, COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.PAYMENT_TOKEN END) AS eftpos_volume
, SUM(CASE WHEN fpt.card_brand = 'VISA' THEN fpt.AMOUNT_BASE_UNIT END) / COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'VISA' THEN fpt.PAYMENT_TOKEN END) / 100 AS visa_ats
, SUM(CASE WHEN fpt.CARD_BRAND = 'MASTER_CARD' THEN fpt.AMOUNT_BASE_UNIT END) / COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'MASTER_CARD' THEN fpt.PAYMENT_TOKEN END) / 100 AS mastercard_ats
, IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'AMERICAN_EXPRESS' THEN fpt.AMOUNT_BASE_UNIT END) / COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'AMERICAN_EXPRESS' THEN fpt.PAYMENT_TOKEN END) / 100, 0) AS amex_ats
, IFNULL(SUM(CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.AMOUNT_BASE_UNIT END) / COUNT(DISTINCT CASE WHEN fpt.CARD_BRAND = 'EFTPOS' THEN fpt.PAYMENT_TOKEN END) / 100, 0) AS eftpos_ats
FROM APP_BI.PENTAGON.FACT_PAYMENT_TRANSACTIONS fpt
INNER JOIN APP_BI.PENTAGON.DIM_CARD dc
ON fpt.PAN_FIDELIUS_TOKEN = dc.PAN_FIDELIUS_TOKEN
INNER JOIN APP_BI.PENTAGON.DIM_USER du
ON du.USER_TOKEN = fpt.unit_token
WHERE fpt.CURRENCY_CODE = 'AUD'
AND fpt.is_gpv = 1
AND du.BEST_AVAILABLE_MERCHANT_TOKEN in (
'SKPFD5D1E08VS'
)
--AND fpt.unit_token = 'GFSKNB2B1B441' --change the to IN for multiple user token
AND 
(fpt.payment_trx_recognized_date BETWEEN '2021-01-01'::DATE AND'2022-02-17'::DATE)
//                       fpt.payment_trx_recognized_date >= current_date -98     --- <---- CONFIGURE YOUR START AND END DATES HERE
//                   and fpt.payment_trx_recognized_date <  current_date -7 
GROUP BY 1;
